# Tax-Loss Harvesting Backtesting Engine

[![View Full Project Report](https://img.shields.io/badge/View-Full_Report_PDF-blue?style=for-the-badge&logo=adobeacrobatreader)](results/writeup.pdf)

This project simulates and evaluates the performance of **Tax-Loss Harvesting (TLH)** strategies on a Direct Indexing portfolio tracking the S&P 500 (Top 50 constituents) over the last 20 years (2004-2024).

The core goal is to quantify the **"Tax Alpha"** generated by actively harvesting losses versus a simple Buy & Hold baseline, while accounting for Wash Sale rules and different cash flow needs.

## Key Findings (2004-2024)

![Wealth Curve](images/wealth_curves_wealth_over_time_-_income_withdrawal.png)

1.  **"No Wash" Strategy Wins**: The theoretical best performer was the **Greedy (No Wash)** strategy (**$28.2M** vs $25.9M Baseline). By ignoring the 30-day lockout period, it captured tax credits without missing out on market rebounds ("Cash Drag").
2.  **Cash Drag Hurts**: Strategies that strictly obeyed wash sale rules (Greedy With Wash, Optimized) **underperformed** the simple Buy & Hold baseline (**$25.0M** vs $25.9M). In a strong bull market like 2004-2024, the opportunity cost of sitting in cash for 30 days outweighed the tax benefits of harvesting.
3.  **Charity is Powerful**: The "Charitable Giving" scenario (annual contribution + terminal donation) resulted in the highest final wealth (**$83.3M**) because it avoids the massive liquidation tax at the end of the investment horizon.

## Methodology

*   **Universe**: Top 50 S&P 500 stocks.
*   **Period**: Jan 1, 2004 - Jan 1, 2024 (20 Years).
*   **Initial Capital**: $10,000,000.
*   **Tax Rate**: Flat 20%.
*   **Reinvestment**: Realized losses generate an immediate tax credit (`Loss * 0.20`) which is reinvested into the portfolio.

### Strategies Tested
1.  **Baseline**: Buy & Hold (Monthly Rebalancing). No harvesting.
2.  **Greedy (No Wash)**: Sells losers and immediately buys them back. Captures tax alpha but violates wash sale rules.
3.  **Greedy (With Wash)**: Sells losers and holds cash for 30 days before buying back. Compliant but suffers from cash drag.
4.  **Optimized**: Uses convex optimization (`cvxpy`) to track the index while avoiding restricted stocks.

## Results Summary

**Scenario 1: Income Withdrawal** (Withdraw 5%/year, Pay Tax at End)
| Strategy | Final Wealth | Taxes Paid | Realized Losses |
| :--- | :--- | :--- | :--- |
| **Baseline** | $26.0M | $6.6M | $1.9M |
| **Greedy (No Wash)** | **$28.2M** | $7.0M | $6.4M |
| **Greedy (With Wash)** | $25.1M | $5.1M | $22.6M |
| **Optimized** | $24.9M | $5.0M | $22.7M |

**Scenario 2: Charitable Giving** (Contribute $1M/year, Donate at End)
| Strategy | Final Wealth | Taxes Paid | Realized Losses |
| :--- | :--- | :--- | :--- |
| **Baseline** | $76.0M | $3.5M | $3.4M |
| **Greedy (No Wash)** | **$83.3M** | $2.9M | $13.7M |
| **Greedy (With Wash)** | $65.8M | $7.6M | $44.1M |
| **Optimized** | $67.9M | $7.9M | $44.9M |

## How to Run

1.  Install dependencies:
    ```bash
    pip install -r requirements.txt
    ```
2.  Run the simulation:
    ```bash
    python src/main.py
    ```
    This will download the latest data, run all 8 simulations, and generate the plots and CSV results found in this repo.

3.  Run the Demo:
    ```bash
    python src/demo.py
    ```
